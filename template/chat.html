<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Chat sahifasi</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .chat-box { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
    .msg { margin: 5px; padding: 8px; border-radius: 8px; }
    .me { background-color: #d1ffd1; text-align: right; }
    .other { background-color: #eaeaea; text-align: left; }
    button { margin-top: 10px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h2>💬 {{ chat_room }}</h2>

  <div class="chat-box" id="chatBox">
    {% for msg in messages %}
      <div class="msg {% if msg.sender == request.user %}me{% else %}other{% endif %}">
        <strong>{{ msg.sender.username }}:</strong> {{ msg.content }}
      </div>
    {% endfor %}
  </div>

  <form id="msgForm" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="text" id="msgInput" name="content" placeholder="Xabar yozing..." style="width:80%">
    <button type="submit">Yuborish</button>
  </form>

  <button id="enable-notifications">🔔 Bildirishnomani yoqish</button>

  <script>
    const roomId = "{{ chat_room.id }}";

    // 📨 Xabar yuborish formasi
    document.getElementById("msgForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      const response = await fetch(`/chat/${roomId}/send/`, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
      });

      const data = await response.json();

      if (response.ok) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.classList.add("msg", "me");
        div.innerHTML = `<strong>Siz:</strong> ${data.content}`;
        box.appendChild(div);
        document.getElementById("msgInput").value = "";
      } else {
        alert("Xatolik: " + data.error);
      }
    });

  const firebaseConfig = {
    apiKey: "{{ FIREBASE_CONFIG.apiKey }}",
    authDomain: "{{ FIREBASE_CONFIG.authDomain }}",
    projectId: "{{ FIREBASE_CONFIG.projectId }}",
    storageBucket: "{{ FIREBASE_CONFIG.storageBucket }}",
    messagingSenderId: "{{ FIREBASE_CONFIG.messagingSenderId }}",
    appId: "{{ FIREBASE_CONFIG.appId }}"
  };
  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  // Public VAPID key - Firebase Console dan oling va trim qiling
   const VAPID_KEY = "{{ FIREBASE_VAPID_KEY }}";
  // Tugma bosilganda ishlaydigan funksiya
  async function enableNotifications() {
    try {
      if (!('serviceWorker' in navigator)) throw new Error('Service Worker qo`llab-quvvatlanmaydi');

      // 1) ro'yxatdan o'tkaz (root scope uchun path /firebase-messaging-sw.js)
      console.log('🔁 Registering service worker...');
      const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {scope: '/'});
      console.log('✅ register() returned:', registration);

      // 2) ro'yxatlash tugaguncha yoki active bo'lguncha kutish
      const readyReg = await navigator.serviceWorker.ready;
      console.log('✅ navigator.serviceWorker.ready:', readyReg);

      // 3) messaging bilan service workerni bog'lash (v8)
      try {
        messaging.useServiceWorker(readyReg);
      } catch (e) {
        // ba'zan v8 da useServiceWorker ishlamasligi mumkin, ammo readyReg ni getToken ga beramiz
        console.warn('useServiceWorker warning:', e);
      }

      // 4) ruxsatni so'rash — ESDA: buni user gesture ichida chaqirish kerak
      const permission = await Notification.requestPermission();
      console.log('Notification permission:', permission);
      if (permission !== 'granted') {
        console.warn('❌ Permission not granted');
        return;
      }

      // 5) token olish — vapidKey va service worker registration bilan
      let token;
      try {
        token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: readyReg });
      } catch (err) {
        console.error('❌ getToken() failed:', err);
        throw err;
      }

      if (!token) {
        console.warn('⚠️ getToken returned null/undefined');
        return;
      }

      console.log('📱 FCM token:', token);

      // 6) tokenni backendga yuborish
      fetch('/api/save-fcm-token/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ token })
      }).then(r => r.json()).then(d => console.log('save-token:', d)).catch(e => console.error(e));

    } catch (err) {
      console.error('❌ Error retrieving push subscription (outer):', err);
      // Agar kerak bo'lsa, xatolikni foydalanuvchiga ko'rsatish
      alert('Push subscription xatosi: ' + (err.message || err));
    }
  }

  // Tugmaga qo'shing (sizda mavjud tugma)
  document.getElementById('enable-notifications').addEventListener('click', enableNotifications);

  // Foreground xabar qabul qilish
  messaging.onMessage(payload => {
    console.log('📩 onMessage:', payload);
    const body = payload.notification?.body || JSON.stringify(payload);
    alert('📬 ' + body);
  });
  </script>
</body>
</html>
